<div class="container">
  <h1 class="index-title mb-3" style="text-align: center";><%= @chat_title %></h1>
  <% @chats.each do |chat| %>
    <div class="row msg-card">
      <div class="avatar-section col-4">
        <%= image_tag "https://res.cloudinary.com/rts1307/image/upload/v1771606859/development/gregoryhouse.jpg",
              class: "avatar-small", style: "width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" %>

        <%# If a pet doesn't have a picture, a paw icon will be used %>
        <%# When a pet goes to Heart Gallery, the chat picture is not available %>
        <% if chat.pet&.photo&.attached? %>
        <%= image_tag chat.pet.photo,
              class: "avatar-small overlap",
              style: "width: 50px; height: 50px; border-radius: 50%; object-fit: cover;" %>
        <% else %>
          <div class="avatar-small overlap" style="width: 50px; height: 50px; border-radius: 50%; background: #eee; display: inline-flex; align-items: center; justify-content: center; border: 2px solid white;">
            <i class="fa-solid fa-paw" style="color: #bbb;"></i>
          </div>
        <% end %>

      </div>
      <div class="col-5">
        <%= link_to user_chat_path(@user, chat) do %>
          <h5> <%= chat.vet.clinic.clinic_name %> </h5>
          <h6> For: <%= chat.pet&.name || "Unknown Pet" %> </h6>
        <% end %>
      </div>
      <div class="col-3">
        <% if chat.messages.last&.updated_at&.today? %>
          <p> <%= chat.messages.last.updated_at.in_time_zone('Tokyo').strftime("%m:%M%p")%> </p>
        <% else %>
          <%= chat.messages.last&.updated_at&.strftime("%m/%e") %>
        <% end %>
        <% if chat.archived? %>
          <%# Unarchiving the chat %>
          <%= link_to unarchive_user_chat_path(current_user, chat), data: { turbo_method: :patch, turbo_confirm: "Unarchive this chat?"} do %>
            <h3><i class="fa-regular fa-eye" style="color: #A3B899"></i></h3>
          <% end %>
        <% else %>
          <%# Archiving the chat %>
          <%= link_to archive_user_chat_path(current_user, chat), data: { turbo_method: :patch, turbo_confirm: "Archive this chat?"} do %>
            <h3><i class="fa-regular fa-eye-slash" style="color: #6c757d"></i></h3>
          <% end %>
        <% end %>
      </div>
      <div class="mb-2" style="padding-left: 40px">
        <% if chat.messages.last.user == @user %>
          <p> You: <%= truncate(chat.messages.last.contents, length: 27, separator: ' ') %> </p>
        <% else %>
          <p> <%= chat.vet.clinic.clinic_name %>:  <%= truncate(chat.messages.last.contents, length: 27, separator: ' ') %> </p>
        <% end %>
      </div>
    </div>
    <hr>
  <% end %>
  <div class="fixed-bottom d-flex justify-content-end p-3">
    <%= link_to new_user_chat_path, method: :post do %>
      <i class="fa-solid fa-plus" style="font-size: 40px"></i>
    <% end %>
  </div>
</div>
<style>
  hr {
    margin-top: 0px;
  }

  .avatar-small.overlap {
  margin-left: -15px;
  }

  .col-4 {
    padding: 0px;
    padding-left: 4%;
  }

  .col-5 {
    padding: 0px;
  }

  .col-3 {
    padding: 0px;
  }
</style>
